---
output: 
  html_document: 
    fig_height: 8
    fig_width: 10
---
Reading in the data to a data.frame object.
```{r}
data <- read.csv("OSMI Mental Health in Tech Survey 2017-18.csv", header=TRUE)
```

Replacing the dates in the 'how.many.employees...' with proper ranges.
```{r}
levels(data$How.many.employees.does.your.company.or.organization.have.) <- c(levels(data$How.many.employees.does.your.company.or.organization.have.), "1-5", "6-25")
data$How.many.employees.does.your.company.or.organization.have.[data$How.many.employees.does.your.company.or.organization.have.=="5-Jan"] <- "1-5"
data$How.many.employees.does.your.company.or.organization.have.[data$How.many.employees.does.your.company.or.organization.have.=="25-Jun"] <- "6-25"
```

For all of the columns asking if they have a certain mental health issue, replaces the value with a '1' if they do and a '0' if they don't.
```{r}
#64 -> 89
for(i in 64:89){
  levels(data[[i]]) <- c(levels(data[[i]]), 0, 1)
  for(j in 1:nrow(data)){
    data[[i]][j] <- if(is.na(data[[i]][j]) | data[[i]][j] == "") 0 else 1
  }
}
```

Combines the results of the third set of questions about mental health issues into the second
```{r}
#77 -> 89
for(i in 89:77){
  for(j in 1:nrow(data)){
    if(data[[i]][j] == 1){
      data[[i - 13]][j] <- data[[i]][j]
    }
  }
  data[[i]] <- NULL
}
```

Removes all the repeat columns asking if they have a certain mental health issue that are completely blank.
```{r}
#51 -> 63
for(i in 63:51){
  data[[i]] <- NULL 
}
```

```{r}
table(data$Have.you.ever.been.diagnosed.with.a.mental.health.disorder.)
```


Cleanup Diagnosis Check column

if there was a diagnosis on a specific disorder the "Have.you.ever.been.diagnosed.with.a.mental.health.disorder." column is marked as a "Yes"
```{r}
for(j in 1:nrow(data)){
  for(i in 63:51){
    if(data[[50]][j] == ""){
      if(data[[i]][j] == 1){
        data[[50]][j] <- "Yes"
      }
    }
  }
}
```
```{r}
table(data$Have.you.ever.been.diagnosed.with.a.mental.health.disorder.)
```
```{r}
table(data$Do.you.currently.have.a.mental.health.disorder.)
table(data$Have.you.had.a.mental.health.disorder.in.the.past.)
```
```{r}
levels(data$Have.you.had.a.mental.health.disorder.in.the.past.)
levels(data$Do.you.currently.have.a.mental.health.disorder.)
levels(data$Have.you.ever.been.diagnosed.with.a.mental.health.disorder.)
```

```{r}
data$Have.you.ever.been.diagnosed.with.a.mental.health.disorder. <- as.character(data$Have.you.ever.been.diagnosed.with.a.mental.health.disorder.)
```

```{r}
for(j in 1:nrow(data)){
  if(data[[50]][j] == ("") || is.na(data[[50]][j]) == TRUE){
    if(data[[49]][j] == "No" && data[[64]][j] == "No"){
      data[[50]][j] <- "No"
    }else if(data[[49]][j] == ("Don't Know")){
      if(data[[64]][j] == ("Don't Know")){
        data[[50]][j] <- "Maybe"
      }else if(data[[64]][j] == ("Possibly")){
        data[[50]][j] <- "Maybe"
      }else if(data[[64]][j] == "Yes"){
        data[[50]][j] <- "Maybe"
      }
    }else if(data[[49]][j] == "Possibly"){
      if(data[[64]][j] == "Don't Know"){
        data[[50]][j] <- "Maybe"
      }else if(data[[64]][j] == "Possibly"){
        data[[50]][j] <- "Maybe"
      }else if(data[[64]][j] == "Yes"){
        data[[50]][j] <- "Maybe"
      }
    }else if(data[[49]][j] == "No"){
      if(data[[64]][j] == "Don't Know"){
        data[[50]][j] <- "No"
      }else if(data[[64]][j] == "Possibly"){
        data[[50]][j] <- "No"
      }
    }
  }
}

data$Have.you.ever.been.diagnosed.with.a.mental.health.disorder. <- as.factor(data$Have.you.ever.been.diagnosed.with.a.mental.health.disorder.)
```

```{r}
table(data$Have.you.ever.been.diagnosed.with.a.mental.health.disorder.)
test <- c(table(data$Have.you.ever.been.diagnosed.with.a.mental.health.disorder.)[2:4])
sum(test)
data
```


Data Cleanup: Gender

Resources:
https://www.genderspectrum.org/quick-links/understanding-gender/
https://en.wikipedia.org/wiki/Non-binary_gender

```{r}
table(data$What.is.your.gender.)
```
```{r}
cis_female <- c( 'Female', 'female', 'Female ', 'Woman', 'woman', 'F', 'f', 'I identify as female', '*shrug emoji* (F)', 'Cis woman', 'Female (cisgender)', 'Cis-Female', 'Cisgendered woman', 'She/her/they/them', 'Cis female', 'cisgender female', 'femalw', 'femail', 'female (cis)', 'My sex is female.', 'female (cisgender)', 'Female (cis) ', 'Woman-identified', 'cis-Female', 'cis female', 'F, cisgender', 'Cis female ')
cis_male <- c('male', 'Male', 'Ostensibly Male', 'male, born with xy chromosoms', 'Malel', 'M', 'MALE', 'm', 'Cis-male', 'Male ', 'cis male ', 'Cis Male', 'Man', 'Cisgender male', 'cis-male', 'Mail', 'cis hetero male', 'Male (cis)', "male (hey this is the tech industry you're talking about)", 'God King of the Valajar', 'Cis male', 'man', 'Male, cis', 'cis male', 'dude' , 'SWM')
transgender <- c('transgender', 'Trans woman', 'Trans female', 'trans woman', 'Transfeminine', 'Trans man')
gq <- c('male/androgynous ', 'Agender', '', 'Nonbinary', 'Male (or female, or both)', 'non binary', 'Female/gender non-binary.', 'N/A', 'genderfluid', 'Genderqueer', 'Demiguy', 'none', 'non-binary', 'Other', 'NB', 'Genderfluid', 'Nonbinary/femme', 'gender non-conforming woman', 'uhhhhhhhhh fem genderqueer?', 'n/a', 'Non-binary', 'Agender/genderfluid', 'Male-ish', 'sometimes', 'Contextual', 'Non binary', 'Genderqueer demigirl', 'Genderqueer/non-binary', 'nonbinary', 'Female-ish', '\\-', 'None')
```

```{r}
gender <- as.vector(data$What.is.your.gender.)
n <- length(gender)
for(i in 1:n){
  if(gender[i] %in% cis_female){
    gender[i] <- "cis-female"
  }else if (gender[i] %in% gq){
    gender[i] <- "genderqueer"
  }else if (gender[i] %in% transgender){
    gender[i] <- "transgender"
  }else if (gender[i] %in% cis_male){
    gender[i] <- "cis-male"
  }else{
    gender[i]
  }
}
```

```{r}
table(gender)
```

```{r}
data$What.is.your.gender. <- gender
```

```{r}
data$What.is.your.gender. <- as.factor(data$What.is.your.gender.)
```


```{r}
table(data$What.is.your.gender.)
```
```{r}
data
```
```{r}
str(data$What.is.your.gender.)
```

WordCloud representing what employees think employers can do to improve mental health support
```{r}
library("tm")
library("wordcloud")

corpus <- Corpus(VectorSource(data$Briefly.describe.what.you.think.the.industry.as.a.whole.and.or.employers.could.do.to.improve.mental.health.support.for.employees.))
corpus

corpus <- tm_map(corpus, content_transformer(tolower))
corpus <- tm_map(corpus, removePunctuation)
corpus <- tm_map(corpus, function(x) removeWords(x, stopwords("english")))
corpus <- tm_map(corpus, function(x) removeWords(x, c("like", "can", "also", "mental", "health", "dont","just")))

pal = brewer.pal(5, "Blues")
pal[1] = "slategray1"

wordcloud(corpus,min.freq=1, max.words=60, scale=c(3,.5), colors=pal)




```

WordCloud representing the factors involved in whether or not an employee chooses to talk about mental health with employers/potential employers
```{r}
library("tm")
library("wordcloud")

words.all <- as.vector(as.matrix(data[,c("Why.or.why.not.","Why.or.why.not..1")]))

words.corpus<-Corpus(VectorSource((words.all)))
words.corpus

words.corpus <- tm_map(words.corpus, content_transformer(tolower))
words.corpus <- tm_map(words.corpus, removePunctuation)
words.corpus <- tm_map(words.corpus, function(x) removeWords(x, stopwords("english")))
words.corpus <- tm_map(words.corpus, function(x) removeWords(x, c("job", "mental", "health", "issues")))


pal = brewer.pal(5, "Reds")

wordcloud(words.corpus,min.freq=1, max.words=60, scale=c(3,.5), colors=pal)
```


```{r}
library(e1071)

library(ggplot2)
library(caret)
library(Amelia)
library(caretEnsemble)
library(psych)
library(mice)
library(GGally)
library(rpart)
library(randomForest)
library(data.table)


t <- data[,c(3:22, 75, 78, 79)]
#t <- data[,c(3,4,5)]


t$data.Overall..how.well.do.you.think.the.tech.industry.supports.employees.with.mental.health.issues. <- data$Overall..how.well.do.you.think.the.tech.industry.supports.employees.with.mental.health.issues.

t$data.Overall..how.well.do.you.think.the.tech.industry.supports.employees.with.mental.health.issues. <- as.factor(t$data.Overall..how.well.do.you.think.the.tech.industry.supports.employees.with.mental.health.issues.)

t$Describe.the.conversation.with.coworkers.you.had.about.your.mental.health.including.their.reactions. <- NULL
t$Describe.the.conversation.you.had.with.your.employer.about.your.mental.health..including.their.reactions.and.what.actions.were.taken.to.address.your.mental.health.issue.questions. <- NULL
t$Describe.the.conversation.your.coworker.had.with.you.about.their.mental.health..please.do.not.use.names.. <- NULL
t
indxTrain <- createDataPartition(y = t$data.Overall..how.well.do.you.think.the.tech.industry.supports.employees.with.mental.health.issues., p = 0.75,list = FALSE)
training <- t[indxTrain,]
testing <- t[-indxTrain,]

x = na.omit(data.frame(training[,1:21]))

x$data.Overall..how.well.do.you.think.the.tech.industry.supports.employees.with.mental.health.issues. <- as.factor(x$data.Overall..how.well.do.you.think.the.tech.industry.supports.employees.with.mental.health.issues.)

y = x$data.Overall..how.well.do.you.think.the.tech.industry.supports.employees.with.mental.health.issues.

x$data.Overall..how.well.do.you.think.the.tech.industry.supports.employees.with.mental.health.issues. <- NULL

y <- as.factor(y)


setnames(x, 1:20, new = c('# of employees', 'primarily tech', 'role IT related', 'MH coverage', 'options for MH care', 'formally discussed MH', 'employer offer resources', 'is anonymity protected', 'medical leave feasability', 'comfortable talking health w/ coworkers', 'comfortable talking health w/ supervisor', 'comfortable talking health w/ employer', 'comfortable talking MH w/ coworkers', 'ever discussed MH w/ coworkers' ,'ever had coworker discuss MH w/ you', 'employer importance on health', 'employer importance on MH', 'openly identify w/ MH', 'how would coworkers react if you had MH', 'observed lack of support to MH @ work?'))
x

model = train(x, y,'nb',trControl=trainControl(method='cv',number=10))
model

setnames(testing, 1:20, new = c('# of employees', 'primarily tech', 'role IT related', 'MH coverage', 'options for MH care', 'formally discussed MH', 'employer offer resources', 'is anonymity protected', 'medical leave feasability', 'comfortable talking health w/ coworkers', 'comfortable talking health w/ supervisor', 'comfortable talking health w/ employer', 'comfortable talking MH w/ coworkers', 'ever discussed MH w/ coworkers' ,'ever had coworker discuss MH w/ you', 'employer importance on health', 'employer importance on MH', 'openly identify w/ MH', 'how would coworkers react if you had MH', 'observed lack of support to MH @ work?'))

Predict <- predict(model,newdata = testing )
confusionMatrix(Predict, testing$data.Overall..how.well.do.you.think.the.tech.industry.supports.employees.with.mental.health.issues. )

#Plot Variable performance
pl <- varImp(model)
pdf("rplot.pdf") 
plot(pl)
dev.off()
```
